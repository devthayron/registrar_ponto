{% extends "base.html" %}
{% load static %}
{% block title %}Consultar Registros{% endblock %}

{% block content %}
<div class="gerente-container">


<form method="get" autocomplete="off">
  <label for="cpf">CPF:</label>
  <input
    type="text"
    name="cpf"
    id="cpf"
    value="{{ cpf|default:'' }}"
    placeholder="Digite o CPF"
    maxlength="14"
    pattern="(\d{11}|(\d{3}\.\d{3}\.\d{3}-\d{2}))"
    inputmode="numeric"
    oninput="this.value = this.value.replace(/[^0-9.-]/g, '').slice(0,14);"
  />

  <label for="lider">Contrato:</label>
  <select name="lider" id="lider" class="dropdown">
    <option value="" {% if not lider %}selected{% endif %}>Todos</option>
    {% for l in lideres %}
      <option value="{{ l.id }}" {% if l.id|stringformat:"s" == lider %}selected{% endif %}>{{ l.nome }}</option>
    {% endfor %}
  </select>

    <label for="data_inicial">Data Inicial:</label>
    <input class="dropdown data"
      type="date"
      id="data_inicial"
      name="data_inicial"
      value="{{ data_inicial|default:'' }}"
    />

    <label for="data_final">Data Final:</label>
    <input class="dropdown data"
      type="date"
      id="data_final"
      name="data_final"
      value="{{ data_final|default:'' }}"
    />

  <button type="submit">Buscar</button>
  <a href="{% url 'listar_pontos' %}">Limpar</a>
</form>

  {% if registros %}
    {% if cpf %}
      <h3>Registros para CPF {{ cpf }}</h3>
    {% else %}

    {% endif %}
    <table>
      <thead>
        <tr>
          <th>CPF</th>
          <th>Nome</th>
          <th>Data</th>
          <th>Entrada</th>
          <th>Contrato</th>
        </tr>
      </thead>
      <tbody>
        {% for r in registros %}
        <tr>
          <td>
            {% if r.colaborador and r.colaborador.cpf %}
            {{ r.colaborador.cpf|slice:":3" }}.{{ r.colaborador.cpf|slice:"3:6" }}.{{ r.colaborador.cpf|slice:"6:9"}}-{{ r.colaborador.cpf|slice:"9:11" }}
            {% else %}
            -
            {% endif %}
          </td>
          <td>{{ r.colaborador.nome|default:"-" }}</td>
          <td>{{ r.data|date:"d/m/Y" }}</td>
          <td>{% if r.entrada %}{{ r.entrada|time:"H:i" }}{% else %}-{% endif %}</td>
          <td>{{ r.lider_nome|default:"-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
      <div style="display: flex; align-items: center; gap: 12px; justify-content:end; transform: translateY(40px)">
        <a href="{% url 'baixar_historico_geral_pdf' %}?cpf={{ cpf }}&lider={{ lider }}&data_inicial={{ data_inicial }}&data_final={{ data_final }}" title="Baixar PDF">
          <img src="{% static 'img/pdf-icon.jpg' %}" alt="PDF" style="height: 32px;">
        </a>
        <a href="{% url 'baixar_historico_geral_excel' %}?cpf={{ cpf }}&lider={{ lider }}&data_inicial={{ data_inicial }}&data_final={{ data_final }}" title="Baixar Excel">
        <img src="{% static 'img/excel-logo.png' %}" alt="Excel" style="height: 37px;">
      </a>
      </div>
    {% include 'paginacao.html' %}
    {% if total_presencas %}
      <p style="color: #2980b9; text-align: end; transform: translateY(-41px);" class="presenca"><strong>Total de presen√ßas:</strong> {{ total_presencas }}</p>
    {% endif %}
    {% elif cpf %}
    <p>Nenhum registro encontrado para o CPF {{ cpf }}.</p>
    {% else %}
    <p>Nenhum registro encontrado.</p>
    {% endif %}
    
    <script src="{% static 'js/cpf.js' %}"></script>
</div>

{% endblock %}
